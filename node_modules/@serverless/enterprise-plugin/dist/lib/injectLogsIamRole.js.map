{"version":3,"sources":["../../src/lib/injectLogsIamRole.js"],"names":["ctx","sls","service","custom","enterprise","collectLambdaLogs","tenant","accessKey","awsAccountId","provider","compiledCloudFormationTemplate","Resources","EnterpriseLogAccessIamRole","Type","Properties","AssumeRolePolicyDocument","Version","Statement","Effect","Principal","AWS","Action","Condition","StringEquals","tenantUid","Policies","PolicyName","PolicyDocument","Resource","filter","map","logicalId","Outputs","Value"],"mappings":";;;;;;;AAAA;;AACA;;;;;;;;;;;;;;;;;;;;;0BAEe,iBAAeA,GAAf;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,kBAEXA,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBC,MAAhB,IACAH,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBC,MAAhB,CAAuBC,UADvB,IAEAJ,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBC,MAAhB,CAAuBC,UAAvB,CAAkCC,iBAAlC,KAAwD,KAJ7C;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,mBAQW,wCAAsBL,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBI,MAAtC,CARX;;AAAA;AAQPC,YAAAA,SARO;AAAA;AAAA,mBAUkB,8BAAYA,SAAZ,CAVlB;;AAAA;AAAA;AAULC,YAAAA,YAVK,SAULA,YAVK;AAWbR,YAAAA,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBO,QAAhB,CAAyBC,8BAAzB,CAAwDC,SAAxD,CAAkEC,0BAAlE,GAA+F;AAC7FC,cAAAA,IAAI,EAAE,gBADuF;AAE7FC,cAAAA,UAAU,EAAE;AACVC,gBAAAA,wBAAwB,EAAE;AACxBC,kBAAAA,OAAO,EAAE,YADe;AAExBC,kBAAAA,SAAS,EAAE,CACT;AACEC,oBAAAA,MAAM,EAAE,OADV;AAEEC,oBAAAA,SAAS,EAAE;AACTC,sBAAAA,GAAG,EAAG,gBAAeZ,YAAa;AADzB,qBAFb;AAKEa,oBAAAA,MAAM,EAAE,gBALV;AAMEC,oBAAAA,SAAS,EAAE;AACTC,sBAAAA,YAAY,EAAE;AACZ,0CAAmB,wBAAuBvB,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBsB,SAAU;AADxD;AADL;AANb,mBADS;AAFa,iBADhB;AAkBVC,gBAAAA,QAAQ,EAAE,CACR;AACEC,kBAAAA,UAAU,EAAE,iBADd;AAEEC,kBAAAA,cAAc,EAAE;AACdX,oBAAAA,OAAO,EAAE,YADK;AAEdC,oBAAAA,SAAS,EAAE,CACT;AACEC,sBAAAA,MAAM,EAAE,OADV;AAEEG,sBAAAA,MAAM,EAAE,CAAC,sBAAD,CAFV;AAGEO,sBAAAA,QAAQ,EAAE,qBAAQ5B,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBO,QAAhB,CAAyBC,8BAAzB,CAAwDC,SAAhE,EACPkB,MADO,CACA;AAAA;AAAA,4BAAMhB,IAAN,YAAMA,IAAN;;AAAA,+BAAkBA,IAAI,KAAK,qBAA3B;AAAA,uBADA,EAEPiB,GAFO,CAEH;AAAA;AAAA,4BAAEC,SAAF;;AAAA,+BAAkB;AACrB,wCAAc,CAACA,SAAD,EAAY,KAAZ;AADO,yBAAlB;AAAA,uBAFG;AAHZ,qBADS;AAFG;AAFlB,iBADQ;AAlBA;AAFiF,aAA/F;AAyCA/B,YAAAA,GAAG,CAACC,GAAJ,CAAQC,OAAR,CAAgBO,QAAhB,CAAyBC,8BAAzB,CAAwDsB,OAAxD,CAAgEpB,0BAAhE,GAA6F;AAC3FqB,cAAAA,KAAK,EAAE;AACL,8BAAc,CAAC,4BAAD,EAA+B,KAA/B;AADT;AADoF,aAA7F;;AApDa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import { getAccessKeyForTenant, getMetadata } from '@serverless/platform-sdk'\nimport { entries } from 'lodash'\n\nexport default async function(ctx) {\n  if (\n    ctx.sls.service.custom &&\n    ctx.sls.service.custom.enterprise &&\n    ctx.sls.service.custom.enterprise.collectLambdaLogs === false\n  ) {\n    return\n  }\n  const accessKey = await getAccessKeyForTenant(ctx.sls.service.tenant)\n\n  const { awsAccountId } = await getMetadata(accessKey)\n  ctx.sls.service.provider.compiledCloudFormationTemplate.Resources.EnterpriseLogAccessIamRole = {\n    Type: 'AWS::IAM::Role',\n    Properties: {\n      AssumeRolePolicyDocument: {\n        Version: '2012-10-17',\n        Statement: [\n          {\n            Effect: 'Allow',\n            Principal: {\n              AWS: `arn:aws:iam::${awsAccountId}:root`\n            },\n            Action: 'sts:AssumeRole',\n            Condition: {\n              StringEquals: {\n                'sts:ExternalId': `ServerlessEnterprise-${ctx.sls.service.tenantUid}`\n              }\n            }\n          }\n        ]\n      },\n      Policies: [\n        {\n          PolicyName: 'LogFilterAccess',\n          PolicyDocument: {\n            Version: '2012-10-17',\n            Statement: [\n              {\n                Effect: 'Allow',\n                Action: ['logs:FilterLogEvents'],\n                Resource: entries(ctx.sls.service.provider.compiledCloudFormationTemplate.Resources)\n                  .filter(([, { Type }]) => Type === 'AWS::Logs::LogGroup')\n                  .map(([logicalId]) => ({\n                    'Fn::GetAtt': [logicalId, 'Arn']\n                  }))\n              }\n            ]\n          }\n        }\n      ]\n    }\n  }\n  ctx.sls.service.provider.compiledCloudFormationTemplate.Outputs.EnterpriseLogAccessIamRole = {\n    Value: {\n      'Fn::GetAtt': ['EnterpriseLogAccessIamRole', 'Arn']\n    }\n  }\n}\n"],"file":"injectLogsIamRole.js"}